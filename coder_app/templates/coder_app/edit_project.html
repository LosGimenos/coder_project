{% extends "coder_app/base.html" %}

{% block content %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">

    {% url 'coder_app:submit_new_variable' as variable_url %}
    {% url 'coder_app:add_coder' as coder_url %}
{% include 'coder_app/home_tab.html' %}
<h3>Edit Project Details</h3>

    <div class="row">
        <div class="col-md-12">
        <form action={% url 'coder_app:edit_project' project_id=id %} method="post">
            <input class="input--project-id" style="display: none;" name="project_id" value="{{ id }}" />
                {% csrf_token %}
        <div class="col-md-4">
                <label for="project-name">Project Name</label>
                <input class="form-control" type="input" name="project-name" value='{{ project_data.name }}' /> <br />
                <label for="project-rate">Rate per Mention</label>
                <input class="form-control" type="input" name="project-rate" value={{ project_data.rate }} /> <br />
                <label for="projected-cost">Estimated Project Cost</label><br/>
                <span name="projected-cost"><p>{{ projected_project_cost }}</p></span>
                <input class='btn btn-primary' type="submit" value="Submit"/>
        </div>
        </form>
        <div class="col-md-1"></div>
        <div class="col-md-3">
            <div class="ui-widget">
                <label for="project-default-tags">Add Project Tags</label>
                <input id="by_tag" type="text" class="form-control" name="project-default-tags"/>
            </div>
        </div>
        <div class="col-md-4">
                <label for="tags-to-remove[]">Current Project Tags</label>
                <select class='form-control' multiple name="tags-to-remove[]" style="width: 100%; border: 1px solid grey; height: 20vh; overflow: scroll;">
                    {% for tag in tag_data %}
                        <option value="{{ tag.id }}"><span>{{ tag.name }}</span>
                    {% endfor %}
                </select>
                <input class="btn btn-danger" name="remove-variable-tags" type="submit" value="Remove Selected"/>
        </div>
        </div>
    </div>

    <hr />
    <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
            <li>
                <form action={% url 'coder_app:edit_project' project_id=id %} method="post">
                    {% csrf_token %}
                    <input type="submit" name="select-variable-view-button" value="Variables" />
                    <input style="display: none;" name="variable_view" value="{{ variable.id }}" />
                </form>
            </li>
            <li>
                <form action={% url 'coder_app:edit_project' project_id=id %} method="post">
                    {% csrf_token %}
                    <input type="submit" name="select-mention-view-button" value="Mentions" />
                    <input style="display: none;" name="mentions_view" value="{{ variable.id }}" />
                </form>
            </li>
            <li>
                <form action={% url 'coder_app:edit_project' project_id=id %} method="post">
                    {% csrf_token %}
                    <input type="submit" name="assigned-coder-view-button" value="Avail.Coders" />
                    <input style="display: none;" name="available_coder_view" value="{{ variable.id }}" />
                </form>
            </li>
            <li>
                <form action={% url 'coder_app:edit_project' project_id=id %} method="post">
                    {% csrf_token %}
                    <input type="submit" name="select-coder-view-button" value="Assigned Coders" />
                    <input style="display: none;" name="assigned_coder_view" value="{{ variable.id }}" />
                </form>
            </li>
        </ul>
    </div>

        {% if project_edit_view == 'variable' %}
         {% include 'coder_app/variable_table.html' %}
        {% elif project_edit_view == 'coder' %}
            <form action={% url 'coder_app:edit_project' project_id=id %} class="input-group" method="post">
            {% csrf_token %}
                {% include 'coder_app/coder_table.html' %}
                <input style="display: none;" name="project_id" value="{{ id }}" />
                {% if not assigned_or_available %}
                    <input class="btn btn-primary" type="submit" name="add-coders-button" value="Add Coders" />
                {% endif %}
            </form>
        {% elif project_edit_view == 'mention'%}
            {% include 'coder_app/mention_table.html' %}
    {% endif %}

    {% load static %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="{% static 'token_injector.js' %}"></script>
    <script>
        $('#by_tag').autocomplete({
            source: "/coder_project/get_tag_names",
            select: function(event, ui) {
                let projectId = $('.input--project-id').val()
                let url = '/coder_project/' + projectId.toString() + '/edit_project/';

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: {
                        'tag_id': ui.item.id,
                        'add_tag_to_project': true
                    },
                    success: function(json) {
                        window.location.href = json.redirect_url;
                    },
                    error: function(xhr,errmsg,err) {
                        console.log(err);
                    }
                });
            },
            minLength: 2
        });
    </script>
{% endblock %}