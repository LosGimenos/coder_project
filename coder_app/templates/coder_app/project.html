{% extends "coder_app/base.html" %}

{% block content %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    {% include 'coder_app/back_button_project.html' %}
    {% include 'coder_app/nav_tabs.html' %}

    <ol class="breadcrumb breadcrumb-top-left" style="margin-top: 2%;">
        <li><a href="#">Projects</a></li>
        <li><a href="#">Add New Project</a></li>
    </ol>
    <h3>Add New Project</h3>

    <form action={% url 'coder_app:submit_new_project' %} method="post">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-12">
                <div class="col-md-4">
                    <label for="project-name">Project Name</label>
                    <input class="form-control input__project-name" type="input" name="project-name" /> <br />
                    <label for="project-rate">Rate</label>
                    <input class="form-control" type="input" name="project-rate" /> <br />
                    <label>Project Introduction</label>
                    <textarea style="height: 20vh;" name='project-introduction' class="form-control">Introduction for Coders</textarea>
                </div>
                <div class="col-md-2"></div>
                <div class="col-md-4">
                    <div class="ui-widget">
                        <label for="tag_filter">Add Project Tags</label>

                        <div style="display: flex;">
                        <input id='by_tag' class="form-control input__tag" type="text" name="tag_filter" />
                        <button class="btn__tag--add">Add</button>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 5%; margin-bottom: 3%;">
                        <span class="glyphicon glyphicon-arrow-down"></span>
                    </div>
                    <label for="filter--container">Tags to Add</label>
                    <select style="display: none;" class="tag--container__hidden" multiple name="tags_to_add[]">
                    </select>
                    <input class="input__project-tag--hidden" type="hidden" name="hidden_project_tag_value" value="" />
                    <select
                            style="height: 15vh; margin-bottom: 2%; overflow: scroll;"
                            class="tag--container col-md-12" multiple>
                        <option class="new-project-tag"></option>
                    </select>
                    <br />
                    <button class="btn btn-danger tag-remove">Remove Selected Tags</button>
                </div>
            </div>
        </div>

{#        <div class="row">#}
{#            <div class="col-md-12">#}
{#                <div class="col-md-4">#}
{#                    <label for="dataset-name">Link a Dataset</label>#}
{#                    <select name="dataset-name" class="form-control">#}
{#                        {% for dataset in dataset_data %}#}
{#                            <option value="{{ dataset.id }}"><span>{{ dataset.dataset_ID }}</span></option>#}
{#                        {% endfor %}#}
{#                    </select>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
        <div style="margin-left: 1.5%;">
            <div class="row" style="margin-top: 2%;">
                <div class="col-md-2">
                    <input class='btn btn-success btn__submit-new' name="submit_new_project" type="submit" value="Add"/>
                </div>
            </div>
        </div>

    </form>
    <style>
    .tag--container {
        border: 1px solid grey;
        height: 15vh;
        overflow: scroll;
    }

    .input__tag {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }

    .btn__tag--add {
        border-radius: 4px;
        border-bottom-left-radius: 0;
        border-top-left-radius: 0;
    }

    .btn__tag--add:hover {
        background-color: #e6e6e6;
    }

    </style>

    {% load static %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="{% static 'token_injector.js' %}"></script>

    <script>
    const tagsArray = [];
    const globalTagIds = [];
    const hiddenTagContainer = $('.tag--container__hidden');
    const tagContainer = $('.tag--container');
    const hiddenProjectTagInput = $('.input__project-tag--hidden');

    function renderFilterContainer(array, container, type) {
            $(container).empty();

            switch (type) {
                case 'keyword':
                    array.forEach(itemData => {
                    let variableNode =
                        $(`<span name='${itemData.name}'>${itemData.name}<span class='badge keyword-remove'>X</span><br/></span>`);
                        $(container).append(variableNode);
                    });
                    addKeywordHandler();
                    break;

                case 'tag':
                    array.forEach(itemData => {
                        let variableNode =
                        $(`<span name='${itemData.id}'>${itemData.name}<span class='badge tag-remove'>X</span><br/></span>`);
                        $(container).append(variableNode);
                    });
                    break;

                case 'variable':
                    array.forEach(itemData => {
                        let variableNode = $(`<span name='${itemData.id}'>${itemData.name}<br/></span>`);
                        $(container).append(variableNode);
                    });
                    addVariableHandler();
                    break;

                case 'project':
                    array.forEach(itemData => {
                        let variableNode = $(`<span name='${itemData.id}'>${itemData.name}<br/></span>`);
                        $(container).append(variableNode);
                    });
                    addProjectVariablesHandler();
                    break;

                case 'select':
                    array.forEach(itemData => {
                        let variableNode =
                            $(`<option class="tag-option" value='${itemData.id}'><span>${itemData.name}</span></option>`);
                        $(container).append(variableNode);
                    });
                    break;

                case 'hidden':
                array.forEach(itemData => {
                    let variableNode =
                        $(`<option class="hidden-option" selected='selected' value='${itemData.id}'><span>${itemData.name}</span></option>`);
                    $(container).append(variableNode);
                });
                break;
            }
        }

        function renderNewProjectTag(container) {
            let newProjectTagValue = $('.input__project-name').val().replace(/[\W]+/g, '');
            newProjectTagValue = newProjectTagValue.split('').join('');

            const tagNodeString = '<option class="new-project-tag">' + newProjectTagValue + '</option>';
            const newProjectTagNode = $(tagNodeString);
            $(container).prepend(newProjectTagNode);
        }

        $('.tag-remove').click(e => {
            e.preventDefault();
            const tagOption = $('.tag-option');
            $(tagOption).each((index, tag) => {
                if ($(tag).css('color') == 'rgb(0, 0, 0)') {
                    const nodeValue = $(tag).attr('value');
                    $(tagsArray).each((index, tag) => {
                        if (tag.id == nodeValue) {
                            tagsArray.splice(index, 1);
                        }
                    });

                    let indexOfValue = $.inArray(parseInt(nodeValue), globalTagIds);
                    if (indexOfValue >= 0) {
                        globalTagIds.splice(indexOfValue, 1);
                    }

                };
            });
            renderFilterContainer(tagsArray, hiddenTagContainer, 'hidden');
            renderFilterContainer(tagsArray, tagContainer, 'select');
            renderNewProjectTag(tagContainer);
        });


        $('#by_tag').autocomplete({
           source: "/coder_project/get_tag_names",
            select: function (event, ui) {
               let tagId;
               if ($.inArray(ui.item.id, globalTagIds) < 0) {
                   tagId = ui.item.id;
                   const tagData = {
                       'id': tagId,
                       'name': ui.item.label
                   }
                   globalTagIds.push(tagId);
                   tagsArray.unshift(tagData);
                   renderFilterContainer(tagsArray, hiddenTagContainer, 'hidden');
                   renderFilterContainer(tagsArray, tagContainer, 'select');
                   renderNewProjectTag(tagContainer);
               };

               $('#by_tag').val('');
               return false;
            },
           minLength: 2
        })

        $('.input__project-name').keyup(() => {
            const addProjectButton = $('.btn__submit-new');
            const inputValue = $('.input__project-name').val();
            const warningColor = 'rgb(217, 83, 79)';
            const blankButtonColor = '#7f8c8d';

            $.ajax({
                url: '/coder_project/add_project',
                type: 'post',
                data: {
                    'project_name_value': inputValue
                },
                success: function(json) {
                    console.log(json.project_name_check_unique);
                    const isNameUnique = json.project_name_check_unique;
                    if (!isNameUnique) {
                        $('.input__project-name').css('background-color', warningColor);
                        $(addProjectButton).css('pointer-events', 'none');
                        $(addProjectButton).css('background-color', blankButtonColor);
                    } else if ($('.input__project-name').css('background-color') == warningColor) {
                        $('.input__project-name').css('background-color', 'white');
                        $(addProjectButton).css('pointer-events', 'auto');
                        $(addProjectButton).css('background-color', '#5cb85c');
                    };

                    let newProjectTagValue = inputValue.replace(/[\W]+/g, '');
                    newProjectTagValue = newProjectTagValue.split('').join('');

                    if ( $('.new-project-tag') ) {
                        $('.new-project-tag').text(newProjectTagValue);
                    }

                    $(hiddenProjectTagInput).val(newProjectTagValue);
                },
                error: {}
            });
        });

    function addTagButtonHandler() {
        $('.btn__tag--add').click(e => {
            e.preventDefault();
            const tagValue = $('#by_tag').val()

            $.ajax({
                url: '/coder_project/get_tag_names',
                type: 'post',
                data: {
                    'tag_action': 'by_add_button',
                    'tag_name': tagValue
                },
                success: function(json) {
                   let tagId;
                   if ($.inArray(json.id, globalTagIds) < 0) {
                       tagId = json.id;
                       const tagData = {
                           'id': tagId,
                           'name': json.name
                       }
                       globalTagIds.push(tagId);
                       tagsArray.unshift(tagData);
                       renderFilterContainer(tagsArray, hiddenTagContainer, 'hidden');
                       renderFilterContainer(tagsArray, tagContainer, 'select');
                       renderNewProjectTag(tagContainer);
                   };

                   $('#by_tag').val('');
                },
                error: function() {}
            });
        });
    }

    addTagButtonHandler();

    </script>

{% endblock %}